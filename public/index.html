<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CrestaTrainer • Demo</title>
  <style>
    :root{
      --brand:#cc0000; --green:#2ecc71; --amber:#ffab00;
      --bg:#f5f5f5; --panel:#fff; --soft:#f3f3f3; --border:#e6e6e6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:#222;font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:flex;flex-direction:column}
    header{background:var(--brand);color:#fff;padding:10px 16px;display:flex;align-items:center;gap:12px}
    .badge{background:#000;color:#fff;font-weight:700;border-radius:999px;padding:4px 10px;font-size:12px}
    .user{font-weight:600;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #wrap{width:min(980px,100%);margin:16px auto;padding:0 12px;flex:1;display:flex;flex-direction:column;gap:12px}
    #card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 6px 14px rgba(0,0,0,.06);display:flex;flex-direction:column;gap:12px;min-height:360px}
    #chat{background:var(--soft);border:1px solid var(--border);border-radius:10px;padding:12px;height:360px;overflow:auto}
    .b{margin:8px 0;padding:10px 12px;border-radius:10px;max-width:75%;white-space:pre-wrap}
    .cli{background:#eee;color:#212121}
    .ven{background:var(--brand);color:#fff;margin-left:auto}
    #bar{display:flex;gap:8px}
    #input{flex:1;padding:10px;border-radius:8px;border:1px solid var(--border);background:#fff}
    button{border:0;border-radius:8px;padding:10px 16px;font-weight:700;cursor:pointer}
    .ok{background:var(--green);color:#fff}
    .end{background:var(--amber);color:#fff}
    #result pre{margin:0;background:#111;color:#0f0;padding:12px;border-radius:8px;overflow:auto}
  </style>
</head>
<body>
  <header>
    <span class="badge" id="mode-badge">Modo: FÁCIL</span>
    <div class="user" id="user-mail">—</div>
  </header>

  <main id="wrap">
    <div id="card">
      <div id="chat"></div>
      <div id="bar">
        <input id="input" placeholder="Escribe tu respuesta…" />
        <button class="ok" id="send">Enviar</button>
        <button class="end" id="finish">Finalizar</button>
      </div>
      <div id="result"></div>
    </div>
  </main>

  <script>
    // ===== Estado y cabecera =====
    const MODE = 'FÁCIL';
    document.getElementById('mode-badge').textContent = 'Modo: ' + MODE;

    let history = [];
    let transcript = [];
    let chosenCar = null;

    (function ensureEmail(){
      let m = localStorage.getItem('trainerEmail') || '';
      if(!m){
        m = prompt('Introduce tu email corporativo para registrar este role-play:', '') || '';
        if(m) localStorage.setItem('trainerEmail', m);
      }
      document.getElementById('user-mail').textContent = m || '—';
    })();

    // ===== UI =====
    function bubble(role, text){
      const div = document.createElement('div');
      div.className = 'b ' + (role === 'cliente' ? 'cli' : 'ven');
      div.textContent = text;
      document.getElementById('chat').appendChild(div);
      document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
      transcript.push({ speaker: role, text });
      history.push({ role: role === 'vendedor' ? 'user' : 'assistant', content: text });
    }

    // ===== Carga de stock robusta =====
    async function loadRandomCar(){
      const fallback = [
        'BMW Serie 1 118d 2019|18.500€|289€/mes',
        'SEAT León 1.5 TSI 2020|17.900€|265€/mes',
        'Volkswagen Golf 1.0 TSI 2021|19.300€|299€/mes',
        'Audi A3 30 TDI 2019|20.400€|315€/mes',
        'Nissan Qashqai 1.3 DIG-T 2020|21.200€|329€/mes',
        'KIA Sportage 1.6 GDi 2018|15.800€|239€/mes'
      ];

      function looksLikeCarLine(rawLine){
        // Fuera comentarios y basura (/* */, //), CSS/JS/HTML y enlaces
        if(!rawLine) return false;
        if(/^\s*\/\*/.test(rawLine)) return false;
        if(/^\s*\/\//.test(rawLine)) return false;
        if(/\/\*/.test(rawLine) || /\*\//.test(rawLine)) return false;
        if(/[{}<>]|<\/?|\bfunction\b|\bconst\b|https?:\/\//i.test(rawLine)) return false;

        const cols = rawLine.split('|').map(x => (x||'').trim());
        if(cols.length < 1 || cols.length > 3) return false;

        // La primera columna debe tener letras y, preferible, un año de 4 dígitos
        const title = cols[0];
        if(!/[A-Za-zÁÉÍÓÚÜÑáéíóúüñ]/.test(title)) return false;
        if(!/\b(19|20)\d{2}\b/.test(title)) return false;

        return true;
      }

      try{
        const r = await fetch('/stock.txt', { cache:'no-store' });
        let lines = [];
        if(r.ok){
          const txt = await r.text();
          lines = txt.split('\n').map(s => s.trim()).filter(looksLikeCarLine);
        }
        if(!lines.length) lines = fallback;

        const pick = lines[Math.floor(Math.random()*lines.length)];
        const [title='', price='', monthly=''] = pick.split('|').map(x => (x||'').trim());

        chosenCar = { title, price, monthly };

        const msgParts = ['Hola, estaba mirando este coche:'];
        if(title) msgParts.push(title);
        if(price || monthly) msgParts.push([price, monthly].filter(Boolean).join(' • '));
        msgParts.push('¿Podrías confirmarme si está disponible para verlo esta semana?');
        bubble('cliente', msgParts.join('\n'));

      }catch(e){
        console.warn('Stock falló:', e);
        chosenCar = { title:'SUV gasolina', price:'', monthly:'' };
        bubble('cliente','Hola, estaba mirando un SUV gasolina que vi en vuestra web. ¿Podrías confirmarme si está disponible para verlo esta semana?');
      }
    }

    // ===== Simulación backend =====
    async function simulate(){
      try{
        const r = await fetch('/api/simulate', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ history, car: chosenCar, nivel: MODE })
        });
        const data = await r.json().catch(()=>({}));
        bubble('cliente', (data && data.reply) ? data.reply : '¿Podrías repetirme?');
      }catch(e){
        bubble('cliente','(hubo un problema temporal, intenta otra vez)');
      }
    }

    // ===== Evaluación backend =====
    async function finish(){
      try{
        if(!window.__startTs) window.__startTs = Date.now();
        const durationSec = Math.max(1, Math.floor((Date.now() - window.__startTs)/1000));
        const r = await fetch('/api/evaluate', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            transcript, car: chosenCar, mode: MODE,
            email: localStorage.getItem('trainerEmail') || '',
            duration_sec: durationSec
          })
        });
        const data = await r.text();
        const pre = document.createElement('pre');
        pre.textContent = data;
        document.getElementById('result').innerHTML = '';
        document.getElementById('result').appendChild(pre);
      }catch(e){
        const pre = document.createElement('pre');
        pre.textContent = 'Error al evaluar: ' + (e?.message || e);
        document.getElementById('result').innerHTML = '';
        document.getElementById('result').appendChild(pre);
      }
    }

    // ===== Eventos =====
    document.getElementById('send').onclick = async ()=>{
      const el = document.getElementById('input');
      const v = el.value.trim();
      if(!v) return;
      el.value = '';
      bubble('vendedor', v);
      await simulate();
    };
    document.getElementById('finish').onclick = finish;

    // Arranque
    window.__startTs = Date.now();
    loadRandomCar();
  </script>
</body>
</html>
