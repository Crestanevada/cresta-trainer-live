<!doctype html>
<html lang="es">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CrestaTrainer • Demo</title>
<style>
  :root { --brand:#cc0000; --ok:#2ecc71; --bg:#f5f5f5; }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); }
  header { background:var(--brand); color:#fff; padding:14px 18px; font-weight:700; }
  #wrap { max-width:900px; margin:18px auto; background:#fff; border-radius:12px; padding:18px; box-shadow:0 10px 20px rgba(0,0,0,.06); }
  #top { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
  #timer { font-weight:700; }
  #modeBadge { background:#111; color:#fff; padding:4px 8px; border-radius:999px; font-size:12px; }
  #who { color:#666; font-size:12px; }
  #chat { border:1px solid #e0e0e0; border-radius:10px; padding:12px; height:420px; overflow:auto; background:#fafafa; }
  .b { margin:8px 0; padding:10px 12px; border-radius:10px; max-width:70%; white-space:pre-wrap; }
  .cli { background:#eee; color:#212121; }
  .ven { background:var(--brand); color:#fff; margin-left:auto; }
  #bar { display:flex; gap:8px; margin-top:12px; }
  #input { flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; }
  button { background:var(--ok); color:#fff; border:0; border-radius:8px; padding:10px 16px; font-weight:700; cursor:pointer; }
  button#finish { background:#ffc107; color:#111; }
  pre { background:#111; color:#0f0; padding:12px; border-radius:8px; overflow:auto; }
  /* Login modal */
  #loginModal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; padding:20px; }
  #loginCard { background:#fff; padding:20px; border-radius:12px; width:100%; max-width:420px; box-shadow:0 10px 30px rgba(0,0,0,.2); }
  #loginCard h2 { margin:0 0 8px 0; }
  #loginCard p { margin:0 0 14px 0; color:#555; }
  #loginCard input { width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px; }
  #loginCard button { width:100%; }
</style>

<body>
  <header>CrestaTrainer • Demo</header>

  <!-- Login -->
  <div id="loginModal" style="display:none;">
    <div id="loginCard">
      <h2>Accede con tu email</h2>
      <p>Usa tu email corporativo para registrar tu entrenamiento.</p>
      <input id="emailInput" type="email" placeholder="nombre@crestanevada.es" />
      <button id="loginBtn">Empezar</button>
      <p id="loginErr" style="color:#c00; display:none; margin-top:8px;">Email no válido.</p>
    </div>
  </div>

  <div id="wrap">
    <div id="top">
      <div>
        <span id="modeBadge">Modo: …</span>
        <span id="who"></span>
      </div>
      <div id="timer">10:00</div>
    </div>

    <div id="chat"></div>

    <div id="bar">
      <textarea id="input" rows="2" placeholder="Escribe tu respuesta..."></textarea>
      <button id="send">Enviar</button>
      <button id="finish">Finalizar</button>
    </div>

    <div id="result" style="margin-top:12px;"></div>
  </div>

<script>
/* ===== Config ===== */
const SESSION_MINUTES = 10; // duración por sesión
let LEVEL = "FÁCIL";        // se auto-asignará desde /api/mode
let sellerEmail = null;

/* ===== Estado ===== */
let history = [];
let transcript = [];
let deadline = Date.now() + SESSION_MINUTES*60*1000;
let locked = false;
let chosenCar = null;

/* ===== Util ===== */
function escapeHtml(s){
  return String(s||"")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}
function bubble(role, text){
  const div = document.createElement('div');
  div.className = 'b ' + (role==="cliente" ? "cli":"ven");
  if(role==="cliente"){ div.innerHTML = escapeHtml(text); history.push({role:"assistant", content:text}); }
  else { div.textContent = text; history.push({role:"user", content:text}); }
  document.getElementById('chat').appendChild(div);
  document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
  transcript.push({speaker: role, text});
}
function tick(){
  const s = Math.max(0, Math.floor((deadline-Date.now())/1000));
  const mm = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  document.getElementById('timer').textContent = `${mm}:${ss}`;
  if(s<=0 && !locked) finish();
}
setInterval(tick,500);

/* ===== Inicio ===== */
async function boot(){
  // 1) Pide / recuerda email
  sellerEmail = localStorage.getItem('ct_email') || null;
  if(!sellerEmail){ document.getElementById('loginModal').style.display = 'flex'; }
  else { await afterLogin(); }
}
document.getElementById('loginBtn').onclick = async ()=>{
  const e = (document.getElementById('emailInput').value || "").trim();
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){
    document.getElementById('loginErr').style.display = 'block'; return;
  }
  document.getElementById('loginErr').style.display = 'none';
  sellerEmail = e;
  localStorage.setItem('ct_email', e);
  document.getElementById('loginModal').style.display = 'none';
  await afterLogin();
};

async function afterLogin(){
  // 2) Modo automático desde /api/mode (según 3 días seguidos ≥7)
  try{
    const r = await fetch(`/api/mode?sellerEmail=${encodeURIComponent(sellerEmail)}`);
    const data = await r.json();
    LEVEL = data.level || "FÁCIL";
  }catch{ LEVEL = "FÁCIL"; }

  document.getElementById('modeBadge').textContent = `Modo: ${LEVEL}`;
  document.getElementById('who').textContent = `• ${sellerEmail}`;

  // 3) Mensaje + coche inicial desde /api/start
  await loadRandomCar();

  // 4) Timer
  deadline = Date.now() + SESSION_MINUTES*60*1000;
}

/* ===== Cargar caso ===== */
async function loadRandomCar() {
  try {
    const r = await fetch('/api/start');
    const { car, first } = await r.json();
    chosenCar = car;
    bubble("cliente", first);
  } catch (e) {
    chosenCar = { title: "SUV gasolina con dudas de consumo", price: "", monthly: "", url: "" };
    bubble("cliente", "Hola, vi un coche en vuestra web y me gustaría saber si lo puedo ver en esta tienda o traerlo para probarlo.");
    console.warn("start error:", e);
  }
}

/* ===== Simulación (cliente IA) ===== */
async function simulate(){
  const r = await fetch('/api/simulate',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ history, car: chosenCar, nivel: LEVEL })
  });
  const data = await r.json();
  bubble("cliente", data.reply || "¿Podrías repetirme?");
}

/* ===== Finalizar ===== */
async function finish(){
  if(locked) return;
  locked = true;
  document.getElementById('send').disabled = true;
  document.getElementById('finish').disabled = true;

  const r = await fetch('/api/evaluate',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ transcript, car: chosenCar, nivel: LEVEL, sellerEmail })
  });
  const text = await r.text();
  const pre = document.createElement('pre');
  pre.textContent = text;
  document.getElementById('result').appendChild(pre);
}

/* ===== UI ===== */
document.getElementById('send').onclick = async ()=>{
  const v = document.getElementById('input').value.trim();
  if(!v) return;
  document.getElementById('input').value = "";
  bubble("vendedor", v);
  await simulate();
};
document.getElementById('finish').onclick = finish;

boot();
</script>
</body>
</html>
