<!doctype html>
<meta charset="utf-8">
<title>CrestaTrainer • Demo</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f5f5f5; }
  header { background:#cc0000; color:#fff; padding:16px 20px; font-weight:700; }
  #wrap { max-width:900px; margin:20px auto; background:#fff; border-radius:12px; padding:20px; box-shadow:0 10px 20px rgba(0,0,0,.06); }
  #top { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
  #timer { font-weight:700; }
  #chat { border:1px solid #e0e0e0; border-radius:10px; padding:12px; height:420px; overflow:auto; background:#fafafa; }
  .b { margin:8px 0; padding:10px 12px; border-radius:10px; max-width:70%; white-space:pre-wrap; }
  .cli { background:#eee; color:#212121; }
  .ven { background:#cc0000; color:#fff; margin-left:auto; }
  #bar { display:flex; gap:8px; margin-top:12px; }
  #input { flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; }
  button { background:#2ecc71; color:#fff; border:0; border-radius:8px; padding:10px 16px; font-weight:700; cursor:pointer; }
  pre { background:#111; color:#0f0; padding:12px; border-radius:8px; overflow:auto; }
</style>
<header>CrestaTrainer • Demo</header>
<div id="wrap">
  <div id="top">
    <div><strong>Nivel:</strong> Medio</div>
    <div id="timer">10:00</div>
  </div>
  <div id="chat"></div>
  <div id="bar">
    <textarea id="input" rows="2" placeholder="Escribe tu respuesta..."></textarea>
    <button id="send">Enviar</button>
    <button id="finish">Finalizar</button>
  </div>
  <div id="result"></div>
</div>
<script>
let history = [];
let transcript = [];
let deadline = Date.now() + 10*60*1000; // Tiempo a 10 minutos
let locked = false;

function tick(){
  const s = Math.max(0, Math.floor((deadline-Date.now())/1000));
  const mm = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  document.getElementById('timer').textContent = `${mm}:${ss}`;
  if(s<=0 && !locked) finish();
}
setInterval(tick,500);

function bubble(role, text){
  const div = document.createElement('div');
  div.className = 'b ' + (role==="cliente" ? "cli":"ven");
  div.textContent = text;
  document.getElementById('chat').appendChild(div);
  document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
  transcript.push({speaker: role, text});
  if(role==="vendedor"){ history.push({role:"user", content:text}); }
  else { history.push({role:"assistant", content:text}); }
}

async function getRandomCar() {
  try {
    const res = await fetch('https://api.allorigins.win/raw?url=https://www.crestanevada.es/coches-segunda-mano/');
    const html = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const carElements = doc.querySelectorAll('.titulo, h2, a');
    let cars = [];
    carElements.forEach(el => {
      let text = el.textContent.trim();
      if (text.length > 10 && /\d{4}/.test(text)) {
        cars.push(text);
      }
    });
    if (cars.length === 0) return "un coche que vi en vuestra web";
    return cars[Math.floor(Math.random() * cars.length)];
  } catch (error) {
    console.error("Error obteniendo coches:", error);
    return "un coche que vi en vuestra web";
  }
}

async function simulate(){
  const r = await fetch('/api/simulate',{method:'POST',headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ history, caso:"Cliente preguntando por un coche específico", nivel:"MEDIO" })});
  const data = await r.json();
  bubble("cliente", data.reply);
}

async function finish(){
  locked = true;
  document.getElementById('send').disabled = true;
  document.getElementById('finish').disabled = true;
  const r = await fetch('/api/evaluate',{method:'POST',headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ transcript })});
  const data = await r.text();
  const pre = document.createElement('pre');
  pre.textContent = data;
  document.getElementById('result').appendChild(pre);
}

document.getElementById('send').onclick = async ()=>{
  const v = document.getElementById('input').value.trim();
  if(!v) return;
  document.getElementById('input').value = "";
  bubble("vendedor", v);
  await simulate();
};
document.getElementById('finish').onclick = finish;

(async () => {
  let car = await getRandomCar();
  let intro = [
    `Hola, vi el ${car} en vuestra web y me gustó mucho, pero me preocupa el consumo en ciudad. ¿Qué me puedes contar?`,
    `Buenas, estuve mirando el ${car} que tenéis en la web y quería saber si está disponible en esta tienda o si me lo podríais traer para verlo y probarlo.`,
    `Hola, estoy interesado en el ${car} que vi en vuestra página. Me gusta más que otras marcas que he visto, pero tengo dudas sobre su mantenimiento.`
  ];
  bubble("cliente", intro[Math.floor(Math.random()*intro.length)]);
})();
</script>
