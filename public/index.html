<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CrestaTrainer • Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #d50000;
      color: white;
      padding: 10px;
      display: flex;
      align-items: center;
    }
    header span {
      margin-right: 10px;
      background-color: black;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 0.9em;
    }
    .chat-container {
      max-width: 900px;
      margin: 20px auto;
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .bubble {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      white-space: pre-line;
    }
    .bubble.cliente {
      background-color: #f0f0f0;
      align-self: flex-start;
    }
    .bubble.vendedor {
      background-color: #d50000;
      color: white;
      align-self: flex-end;
    }
    .input-area {
      display: flex;
      margin-top: 10px;
    }
    .input-area input {
      flex: 1;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .input-area button {
      padding: 10px 15px;
      margin-left: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-enviar {
      background-color: #00c853;
      color: white;
    }
    .btn-finalizar {
      background-color: #ffab00;
      color: white;
    }
  </style>
</head>
<body>
  <header>
    <span id="modo">Modo: FÁCIL</span>
    <div id="usuario">ruben.perrone@crestanebada.es</div>
  </header>

  <div class="chat-container" id="chat"></div>

  <div class="input-area">
    <input type="text" id="input" placeholder="Escribe tu respuesta..." />
    <button class="btn-enviar" onclick="enviar()">Enviar</button>
    <button class="btn-finalizar" onclick="finalizar()">Finalizar</button>
  </div>

  <script>
    let chosenCar = null;

    function bubble(tipo, texto) {
      const chat = document.getElementById("chat");
      const div = document.createElement("div");
      div.classList.add("bubble", tipo);
      div.textContent = texto;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function pickRandomCarFromStock(){
      try{
        const r = await fetch("/stock.txt", { cache:"no-store" });
        if(!r.ok) throw new Error("stock.txt no disponible");
        const txt = await r.text();

        // Filtrar líneas no válidas (CSS, JS, HTML, enlaces, etc.)
        const linesRaw = txt.split("\n").map(s=>s.trim()).filter(Boolean);
        const isLikelyCarLine = (l)=>{
          if(!l) return false;
          if (l.startsWith("#") || l.startsWith("//")) return false;
          if (/[{}<>]|<\/?|\bfunction\b|\bconst\b|https?:\/\//i.test(l)) return false;
          const hasWords = /[A-Za-zÁÉÍÓÚÜÑáéíóúüñ]/.test(l);
          const hasPriceOrYear = /€|\b(20\d{2}|19\d{2})\b/.test(l);
          return hasWords && hasPriceOrYear;
        };
        const lines = linesRaw.filter(isLikelyCarLine);
        if(!lines.length) throw new Error("stock sin líneas válidas");

        const pick = lines[Math.floor(Math.random()*lines.length)];
        const parts = pick.split("|").map(s=>(s||"").trim());
        const title   = parts[0] || "";
        const price   = parts[1] || "";
        const monthly = parts[2] || "";

        chosenCar = { title, price, monthly };

        const msg = [
          "Hola, estaba mirando este coche:",
          title ? title : "",
          (price || monthly) ? [price, monthly].filter(Boolean).join(" • ") : "",
          "¿Podrías confirmarme si está disponible para verlo esta semana?"
        ].filter(Boolean).join("\n");

        bubble("cliente", msg);
      }catch(err){
        console.warn("Fallo stock:", err?.message || err);
        chosenCar = { title:"SUV gasolina", price:"", monthly:"" };
        bubble("cliente",
          "Hola, estaba mirando un SUV gasolina que vi en vuestra web. ¿Podrías confirmarme si está disponible para verlo esta semana?");
      }
    }

    function enviar(){
      const input = document.getElementById("input");
      if(input.value.trim()){
        bubble("vendedor", input.value.trim());
        input.value = "";
      }
    }

    function finalizar(){
      alert("Role play finalizado");
    }

    // Lanzar la primera interacción
    pickRandomCarFromStock();
  </script>
</body>
</html>
