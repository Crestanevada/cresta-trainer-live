<!doctype html>
<meta charset="utf-8">
<title>CrestaTrainer • Demo</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f5f5f5; }
  header { background:#cc0000; color:#fff; padding:16px 20px; font-weight:700; }
  #wrap { max-width:900px; margin:20px auto; background:#fff; border-radius:12px; padding:20px; box-shadow:0 10px 20px rgba(0,0,0,.06); }
  #top { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
  #timer { font-weight:700; }
  #chat { border:1px solid #e0e0e0; border-radius:10px; padding:12px; height:420px; overflow:auto; background:#fafafa; }
  .b { margin:8px 0; padding:10px 12px; border-radius:10px; max-width:70%; white-space:pre-wrap; }
  .cli { background:#eee; color:#212121; }
  .ven { background:#cc0000; color:#fff; margin-left:auto; }
  #bar { display:flex; gap:8px; margin-top:12px; }
  #input { flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; }
  button { background:#2ecc71; color:#fff; border:0; border-radius:8px; padding:10px 16px; font-weight:700; cursor:pointer; }
  pre { background:#111; color:#0f0; padding:12px; border-radius:8px; overflow:auto; }
  small { color:#666 }
</style>

<header>CrestaTrainer • Demo</header>
<div id="wrap">
  <div id="top">
    <div><strong>Nivel:</strong> <span id="nivel">Fácil</span> <small id="emailBox"></small></div>
    <div id="timer">10:00</div>
  </div>
  <div id="chat"></div>
  <div id="bar">
    <textarea id="input" rows="2" placeholder="Escribe tu respuesta..."></textarea>
    <button id="send">Enviar</button>
    <button id="finish">Finalizar</button>
  </div>
  <div id="result"></div>
</div>

<script>
/* ======= CONFIG SENCILLA ======= */
const LEVEL = "FÁCIL";          // FÁCIL | MEDIO | DIFÍCIL | IMPOSIBLE
const SESSION_MINUTES = 10;     // duración del role-play

/* ======= Estado ======= */
let history = [];
let transcript = [];
let deadline = Date.now() + SESSION_MINUTES*60*1000;
let locked = false;
let chosenCar = null;
let userEmail = null;

/* ======= Email requerido (simple) ======= */
(function askEmail(){
  const saved = localStorage.getItem('ct_email');
  if (saved && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(saved)) {
    userEmail = saved;
  } else {
    let e = "";
    while (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)) {
      e = prompt("Introduce tu email corporativo para registrar tu entrenamiento:");
      if (e === null) break;
    }
    if (e) {
      userEmail = e;
      localStorage.setItem('ct_email', e);
    } else {
      userEmail = "desconocido@empresa.com";
    }
  }
  document.getElementById('emailBox').textContent = `• ${userEmail}`;
})();

/* ======= utilidades para links seguros (por si hicieras enlaces en mensajes) ======= */
function escapeHtml(s){
  return s.replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#39;");
}
function linkifySafe(s){
  const esc = escapeHtml(s);
  return esc.replace(/https?:\/\/[^\s<]+/g, (u)=>`<a href="${u}" target="_blank" rel="noopener">${u}</a>`);
}

/* ======= temporizador ======= */
function tick(){
  const s = Math.max(0, Math.floor((deadline-Date.now())/1000));
  const mm = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  document.getElementById('nivel').textContent = LEVEL[0] + LEVEL.slice(1).toLowerCase();
  document.getElementById('timer').textContent = `${mm}:${ss}`;
  if(s<=0 && !locked) finish();
}
setInterval(tick,500);

/* ======= burbujas ======= */
function bubble(role, text){
  const div = document.createElement('div');
  div.className = 'b ' + (role==="cliente" ? "cli":"ven");
  if(role==="cliente"){
    div.innerHTML = linkifySafe(text);
    history.push({role:"assistant", content:text});
  }else{
    div.textContent = text;
    history.push({role:"user", content:text});
  }
  document.getElementById('chat').appendChild(div);
  document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
  transcript.push({speaker: role, text});
}

/* ======= cargar un coche “aleatorio” del stock local (sin enlaces) ======= */
/* Crea el archivo public/stock.txt si no existe, formato: 
   Título|Precio|Cuota
   Ejemplo:
   Fiat 500X Urban 1.6|13.990€|206,04€/mes
   BMW X1 sDrive18d|21.900€|289€/mes
*/
async function loadRandomCar(){
  try{
    const r = await fetch('/stock.txt', { cache: 'no-store' });
    if(!r.ok) throw new Error('stock.txt no disponible');
    const txt = await r.text();
    const lines = txt.split('\n').map(l=>l.trim()).filter(Boolean);
    if(!lines.length) throw new Error('stock vacío');
    const pick = lines[Math.floor(Math.random()*lines.length)].split('|').map(x=>x.trim());
    const title   = pick[0] || "";
    const price   = pick[1] || "";
    const monthly = pick[2] || "";

    chosenCar = { title, price, monthly };

    let first = 'Hola, estaba mirando este coche:\n';
    const parts = [];
    if (title)   parts.push(title);
    if (price)   parts.push(price);
    if (monthly) parts.push(monthly);
    first += parts.join('\n');

    // Lanzamos diálogo inicial con alguna intención (varía un poco)
    const openers = [
      first + "\n¿Podrías confirmarme si está disponible para verlo esta semana?",
      first + "\nTengo dudas sobre el mantenimiento y el historial. ¿Me ayudas?",
      first + "\nMe gusta, pero estoy comparando con otra marca. ¿Qué ventajas tiene este?"
    ];
    bubble("cliente", openers[Math.floor(Math.random()*openers.length)]);
  }catch(e){
    chosenCar = { title: "SUV gasolina", price: "", monthly: "" };
    bubble("cliente","Hola, vi un coche interesante en vuestra web. ¿Podemos hablar para verlo y probarlo?");
  }
}

/* ======= llamar a la IA (simulación del cliente) ======= */
async function simulate(){
  const r = await fetch('/api/simulate',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ history, car: chosenCar, nivel: LEVEL })
  });
  const data = await r.json();
  bubble("cliente", data.reply || "¿Podrías repetirme?");
}

/* ======= finalizar: pide evaluación y registra en Google Sheets ======= */
async function finish(){
  if (locked) return;
  locked = true;
  document.getElementById('send').disabled = true;
  document.getElementById('finish').disabled = true;

  const r = await fetch('/api/evaluate',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ transcript, car: chosenCar, nivel: LEVEL, email: userEmail })
  });
  const data = await r.text();
  const pre = document.createElement('pre');
  pre.textContent = data;
  document.getElementById('result').appendChild(pre);
}

/* ======= eventos UI ======= */
document.getElementById('send').onclick = async ()=>{
  const v = document.getElementById('input').value.trim();
  if(!v) return;
  document.getElementById('input').value = "";
  bubble("vendedor", v);
  await simulate();
};
document.getElementById('finish').onclick = finish;

/* ======= arranque ======= */
loadRandomCar();
</script>
