<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CrestaTrainer • Demo</title>
<style>
  :root{
    --brand:#cc0000;
    --ok:#2ecc71;
    --warn:#f1c40f;
    --ink:#212121;
    --muted:#757575;
    --bg:#f5f5f5;
    --card:#ffffff;
    --bubble:#f3f3f3;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{background:var(--brand);color:#fff;padding:10px 16px;display:flex;gap:12px;align-items:center;position:sticky;top:0;z-index:10}
  .badge{background:#00000033;color:#fff;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:700}
  .email{font-weight:600}
  #wrap{max-width:980px;margin:18px auto;padding:0 12px}
  #panel{background:var(--card);border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.06);padding:14px}
  #top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  #timer{font-weight:800;color:var(--muted)}
  #chat{border:1px solid #e5e5e5;border-radius:10px;padding:12px;height:56vh;min-height:340px;overflow:auto;background:#fafafa}
  .b{margin:10px 0;max-width:78%;white-space:pre-wrap;line-height:1.35}
  .cli{background:var(--bubble);color:var(--ink);padding:10px 12px;border-radius:12px}
  .ven{background:var(--brand);color:#fff;padding:10px 12px;border-radius:12px;margin-left:auto}
  #bar{display:flex;gap:8px;margin-top:12px}
  #input{flex:1;padding:12px;border-radius:8px;border:1px solid #ddd;font:inherit}
  button{border:0;border-radius:8px;padding:10px 16px;font-weight:700;cursor:pointer}
  #send{background:var(--ok);color:#fff}
  #finish{background:var(--warn);color:#000}
  #result pre{background:#111;color:#0f0;padding:12px;border-radius:8px;overflow:auto;max-height:40vh}
  small.muted{color:var(--muted)}
</style>
</head>
<body>

<header>
  <span id="modeBadge" class="badge">Modo: FÁCIL</span>
  <span id="emailLabel" class="email"></span>
</header>

<div id="wrap">
  <div id="panel">
    <div id="top">
      <div><small class="muted" id="clientLabel">Cliente:</small></div>
      <div id="timer">10:00</div>
    </div>

    <div id="chat"></div>

    <div id="bar">
      <textarea id="input" rows="2" placeholder="Escribe tu respuesta..." ></textarea>
      <button id="send">Enviar</button>
      <button id="finish">Finalizar</button>
    </div>

    <div id="result"></div>
  </div>
</div>

<script>
/* =========================
   Estado y utilidades
   ========================= */
let history = [];           // para /api/simulate
let transcript = [];        // para /api/evaluate
let chosenCar = null;       // coche elegido
let startTime = Date.now(); // para duración total
let deadline   = Date.now() + 10*60*1000; // 10 minutos
let locked = false;

// Nivel (modo): puedes forzar por query ?mode=FACIL|MEDIO|DIFICIL|IMPOSIBLE
const urlMode = new URLSearchParams(location.search).get('mode');
const MODE = (urlMode || 'FACIL').toUpperCase(); // texto badge
document.getElementById('modeBadge').textContent = 'Modo: ' + MODE;

// Email guardado (simple)
(function ensureEmail(){
  let email = localStorage.getItem('ct_email');
  if(!email){
    email = prompt('Introduce tu email corporativo (se mostrará en la sesión):','');
    if(email) localStorage.setItem('ct_email', email);
  }
  document.getElementById('emailLabel').textContent = (localStorage.getItem('ct_email') || '');
})();

// Temporizador
function tick(){
  const s = Math.max(0, Math.floor((deadline-Date.now())/1000));
  const mm = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  document.getElementById('timer').textContent = `${mm}:${ss}`;
  if(s<=0 && !locked) finish();
}
setInterval(tick, 500);

// Pintar burbujas
function bubble(role, text){
  const div = document.createElement('div');
  div.className = 'b ' + (role === 'cliente' ? 'cli' : 'ven');

  if(role === 'cliente'){
    // el cliente puede contener saltos y comillas, pero no HTML
    div.textContent = text;
    history.push({ role:'assistant', content:text });
  }else{
    div.textContent = text;
    history.push({ role:'user', content:text });
  }

  document.getElementById('chat').appendChild(div);
  const sc = document.getElementById('chat');
  sc.scrollTop = sc.scrollHeight;
  transcript.push({ speaker: role, text, ts: Date.now() });
}

/* =========================
   Coche aleatorio (lista local editable)
   ========================= */
function loadRandomCarAndGreet(){
  // Edita/añade modelos cuando quieras
  const CARS = [
    { title:"BMW Serie 1 118d 2019",          price:"18.500€", monthly:"289€/mes" },
    { title:"Fiat 500X Urban 2018",           price:"13.990€", monthly:"206€/mes" },
    { title:"Seat León 1.5 TSI 2020",         price:"17.900€", monthly:"249€/mes" },
    { title:"Volkswagen Golf 1.0 TSI 2021",   price:"19.400€", monthly:"275€/mes" },
    { title:"Peugeot 3008 1.2 PureTech 2019", price:"20.900€", monthly:"299€/mes" }
  ];
  chosenCar = CARS[Math.floor(Math.random()*CARS.length)];

  // Nombre del cliente según modo (solo por color/nivel de reto)
  const possibleNames = ["Laura","Carlos","Marta","Javier","Ana","Sergio","Irene"];
  const name = possibleNames[Math.floor(Math.random()*possibleNames.length)];
  document.getElementById('clientLabel').textContent = 'Cliente: ' + name;

  // Construimos la cabecera de coche sin usar backticks anidados
  const parts = [];
  if (chosenCar.title) parts.push(chosenCar.title);
  if (chosenCar.price || chosenCar.monthly) {
    parts.push([chosenCar.price, chosenCar.monthly].filter(Boolean).join(' · '));
  }
  const cabecera = parts.length ? "'" + parts.join(', ') + "'," : "";

  const firstLines = [
    "Hola, estaba mirando este coche:",
    cabecera,
    "¿Podrías confirmarme si está disponible para verlo esta semana?"
  ].join("\n");

  bubble('cliente', firstLines);
}

/* =========================
   Simular turno (llama a tu API existente)
   ========================= */
async function simulateTurn(){
  const payload = { history, car: chosenCar, nivel: MODE };
  const r = await fetch('/api/simulate', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await r.json();
  const reply = data.reply || "¿Podrías repetirlo? No me quedó claro.";
  bubble('cliente', reply);
}

/* =========================
   Finalizar y evaluar
   ========================= */
async function finish(){
  if(locked) return;
  locked = true;
  document.getElementById('send').disabled = true;
  document.getElementById('finish').disabled = true;

  const tiempoSeg = Math.round((Date.now() - startTime)/1000);

  const r = await fetch('/api/evaluate', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      transcript,
      car: chosenCar,
      tiempo_segundos: tiempoSeg,
      email: localStorage.getItem('ct_email') || ''
    })
  });

  const text = await r.text();
  const pre = document.createElement('pre');
  pre.textContent = text;
  document.getElementById('result').appendChild(pre);
}

/* =========================
   Eventos UI
   ========================= */
document.getElementById('send').onclick = async ()=>{
  const ta = document.getElementById('input');
  const v = ta.value.trim();
  if(!v) return;
  ta.value = '';
  bubble('vendedor', v);
  await simulateTurn();
};
document.getElementById('finish').onclick = finish;

// Arranque
loadRandomCarAndGreet();
</script>

</body>
</html>
