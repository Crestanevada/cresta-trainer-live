<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CrestaTrainer • Demo</title>
  <style>
    :root{
      --brand:#cc0000;
      --green:#2ecc71;
      --amber:#ffab00;
      --ink:#111;
      --bg:#f5f5f5;
      --panel:#fff;
      --soft:#f3f3f3;
      --border:#e6e6e6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:#222;
      font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex;
      flex-direction:column;
    }
    /* --- Header corporativo --- */
    header{
      background:var(--brand);
      color:#fff;
      padding:10px 16px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .badge{
      background:#000;
      color:#fff;
      font-weight:700;
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
    }
    .user{
      font-weight:600;
      opacity:.95;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* --- Contenedor principal --- */
    #wrap{
      width:min(980px, 100%);
      margin:16px auto;
      padding:0 12px;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    /* Tarjeta chat */
    #card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:360px;       /* altura cómoda */
    }
    /* Área de mensajes scrollable sin comerse toda la página */
    #chat{
      background:var(--soft);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      height:360px;           /* fija y razonable: evita “página interminable” */
      overflow:auto;
    }
    .b{margin:8px 0; padding:10px 12px; border-radius:10px; max-width:75%; white-space:pre-wrap}
    .cli{background:#eee; color:#212121}
    .ven{background:var(--brand); color:#fff; margin-left:auto}

    /* Barra de entrada */
    #bar{display:flex; gap:8px}
    #input{
      flex:1;
      padding:10px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#fff;
    }
    button{
      border:0; border-radius:8px; padding:10px 16px; font-weight:700; cursor:pointer;
    }
    .ok{background:var(--green); color:#fff}
    .end{background:var(--amber); color:#fff}

    /* Pie de resultados */
    #result pre{
      margin:0; background:#111; color:#0f0; padding:12px; border-radius:8px; overflow:auto
    }
  </style>
</head>
<body>
  <header>
    <span class="badge" id="mode-badge">Modo: FÁCIL</span>
    <div class="user" id="user-mail">—</div>
  </header>

  <main id="wrap">
    <div id="card">
      <div id="chat"></div>
      <div id="bar">
        <input id="input" placeholder="Escribe tu respuesta…" />
        <button class="ok" id="send">Enviar</button>
        <button class="end" id="finish">Finalizar</button>
      </div>
      <div id="result"></div>
    </div>
  </main>

  <script>
    /* =========================
       Estado
    ========================== */
    let history = [];
    let transcript = [];
    let chosenCar = null;              // {title, price, monthly}
    const MODE = 'FÁCIL';              // solo mostramos el modo (no se elige)
    document.getElementById('mode-badge').textContent = 'Modo: ' + MODE;

    // Email (si no existe, lo pedimos 1 vez y lo guardamos)
    (function ensureEmail(){
      let m = localStorage.getItem('trainerEmail') || '';
      if(!m){
        m = prompt('Introduce tu email corporativo para registrar este role-play:', '') || '';
        if(m) localStorage.setItem('trainerEmail', m);
      }
      document.getElementById('user-mail').textContent = m || '—';
    })();

    /* =========================
       Utilidades de UI
    ========================== */
    function bubble(role, text){
      const div = document.createElement('div');
      div.className = 'b ' + (role === 'cliente' ? 'cli' : 'ven');
      div.textContent = text;
      document.getElementById('chat').appendChild(div);
      document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
      transcript.push({ speaker: role, text });
      // Para la IA: mapeamos vendedor->user, cliente->assistant
      if(role === 'vendedor'){ history.push({ role: 'user', content: text }); }
      else { history.push({ role: 'assistant', content: text }); }
    }

    /* =========================
       Lectura de stock
       Formato recomendado: "Título|Precio|Cuota"
       (La URL se omite a propósito por tu petición de “sin enlaces”.)
    ========================== */
    async function loadRandomCar(){
      const fallbackStock = [
        'BMW Serie 1 118d 2019|18.500€|289€/mes',
        'SEAT León 1.5 TSI 2020|17.900€|265€/mes',
        'Volkswagen Golf 1.0 TSI 2021|19.300€|299€/mes',
        'Audi A3 30 TDI 2019|20.400€|315€/mes',
        'Nissan Qashqai 1.3 DIG-T 2020|21.200€|329€/mes',
        'KIA Sportage 1.6 GDi 2018|15.800€|239€/mes'
      ];

      try{
        const r = await fetch('/stock.txt', { cache:'no-store' });
        let lines = [];
        if(r.ok){
          const txt = await r.text();
          const raw = txt.split('\n').map(s => s.trim()).filter(Boolean);
          // Filtramos basura (css/js/html/enlaces)
          const safe = raw.filter(l =>
            !/[{}<>]|<\/?|\bfunction\b|\bconst\b|https?:\/\//i.test(l)
          );
          // Aceptamos solo líneas con 1–3 columnas separadas por |
          lines = safe
            .map(l => l.split('|').map(x => (x||'').trim()))
            .filter(cols => cols.length >= 1 && cols.length <= 3 && /[A-Za-zÁÉÍÓÚÜÑáéíóúüñ]/.test(cols[0]));
          // Recompone a string “a|b|c” para aleatorio
          lines = lines.map(cols => cols.join('|'));
        }

        if(!lines.length) lines = fallbackStock;

        const pick = lines[Math.floor(Math.random()*lines.length)];
        const cols = pick.split('|').map(x => x.trim());
        const title   = cols[0] || '';
        const price   = cols[1] || '';
        const monthly = cols[2] || '';

        chosenCar = { title, price, monthly };

        const parts = ['Hola, estaba mirando este coche:'];
        if(title)   parts.push(title);
        if(price || monthly) parts.push([price, monthly].filter(Boolean).join(' • '));
        parts.push('¿Podrías confirmarme si está disponible para verlo esta semana?');

        bubble('cliente', parts.join('\n'));
      }catch(err){
        console.warn('Stock falló:', err);
        chosenCar = { title:'SUV gasolina', price:'', monthly:'' };
        bubble('cliente','Hola, estaba mirando un SUV gasolina que vi en vuestra web. ¿Podrías confirmarme si está disponible para verlo esta semana?');
      }
    }

    /* =========================
       Simulación (tu backend /api/simulate)
    ========================== */
    async function simulate(){
      try{
        const r = await fetch('/api/simulate', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            history,
            car: chosenCar,
            nivel: MODE
          })
        });
        const data = await r.json().catch(()=>({}));
        const text = (data && data.reply) ? data.reply : '¿Podrías repetirme?';
        bubble('cliente', text);
      }catch(e){
        bubble('cliente','(hubo un problema temporal, intenta otra vez)');
      }
    }

    /* =========================
       Evaluación (tu backend /api/evaluate)
    ========================== */
    async function finish(){
      try{
        // Marca de tiempo: duración del role-play
        if(!window.__startTs) window.__startTs = Date.now();
        const durationSec = Math.max(1, Math.floor((Date.now() - window.__startTs) / 1000));

        const r = await fetch('/api/evaluate', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            transcript,
            car: chosenCar,
            mode: MODE,
            email: localStorage.getItem('trainerEmail') || '',
            duration_sec: durationSec
          })
        });
        const data = await r.text();
        const pre = document.createElement('pre');
        pre.textContent = data;
        document.getElementById('result').innerHTML = '';
        document.getElementById('result').appendChild(pre);
      }catch(e){
        const pre = document.createElement('pre');
        pre.textContent = 'Error al evaluar: ' + (e?.message || e);
        document.getElementById('result').innerHTML = '';
        document.getElementById('result').appendChild(pre);
      }
    }

    /* =========================
       Eventos
    ========================== */
    document.getElementById('send').onclick = async ()=>{
      const el = document.getElementById('input');
      const v = el.value.trim();
      if(!v) return;
      el.value = '';
      bubble('vendedor', v);
      await simulate();
    };
    document.getElementById('finish').onclick = finish;

    // Arranque + cronómetro de la sesión
    window.__startTs = Date.now();
    loadRandomCar();
  </script>
</body>
</html>
