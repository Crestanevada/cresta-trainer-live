<!doctype html>
<meta charset="utf-8">
<title>CrestaTrainer • Demo</title>
<style>
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; background:#f5f5f5; }
  header { background:#cc0000; color:#fff; padding:16px 20px; font-weight:700; }
  #wrap { max-width:900px; margin:20px auto; background:#fff; border-radius:12px; padding:20px; box-shadow:0 10px 20px rgba(0,0,0,.06); }
  #top { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:12px; flex-wrap:wrap; }
  #meta { display:flex; gap:8px; align-items:center; }
  .pill { background:#111; color:#fff; font-size:12px; padding:4px 8px; border-radius:999px; }
  .muted { color:#666; font-size:12px; }
  #timer { font-weight:700; }
  #chat { border:1px solid #e0e0e0; border-radius:10px; padding:12px; height:420px; overflow:auto; background:#fafafa; }
  .b { margin:8px 0; padding:10px 12px; border-radius:10px; max-width:70%; white-space:pre-wrap; }
  .cli { background:#eee; color:#212121; }
  .ven { background:#cc0000; color:#fff; margin-left:auto; }
  #bar { display:flex; gap:8px; margin-top:12px; }
  #input { flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; }
  button { background:#2ecc71; color:#fff; border:0; border-radius:8px; padding:10px 16px; font-weight:700; cursor:pointer; }
  button.warn { background:#f1c40f; color:#111; }
  pre { background:#111; color:#0f0; padding:12px; border-radius:8px; overflow:auto; }
</style>
<header>CrestaTrainer • Demo</header>
<div id="wrap">
  <div id="top">
    <div id="meta">
      <span id="modePill" class="pill">Modo: FÁCIL</span>
      <span id="who" class="muted">–</span>
    </div>
    <div id="timer">10:00</div>
  </div>
  <div id="chat"></div>
  <div id="bar">
    <textarea id="input" rows="2" placeholder="Escribe tu respuesta..."></textarea>
    <button id="send">Enviar</button>
    <button id="finish" class="warn">Finalizar</button>
  </div>
  <div id="result"></div>
</div>

<script>
/* ========= CONFIG BÁSICA ========= */
const SESSION_MINUTES = 10;            // cuenta regresiva visual
const DEFAULT_MODE = "FÁCIL";          // modo mostrado (no seleccionable por el usuario)

/* ========= ESTADO ========= */
let history = [];          // para la API de simulate
let transcript = [];       // para evaluación
let chosenCar = null;      // coche elegido de stock.txt
let locked = false;        // evita doble envío al finalizar
let deadline = Date.now() + SESSION_MINUTES*60*1000;
let startTime = null;      // <<< MARCADOR DE INICIO PARA DURACIÓN
let userEmail = null;

/* ========= UTILIDADES ========= */
const $ = sel => document.querySelector(sel);
function tick(){
  const s = Math.max(0, Math.floor((deadline-Date.now())/1000));
  const mm = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  $("#timer").textContent = `${mm}:${ss}`;
  if(s<=0 && !locked) finish();
}
setInterval(tick, 500);

function bubble(role, text){
  const div = document.createElement('div');
  div.className = 'b ' + (role==="cliente" ? "cli" : "ven");
  div.textContent = text;
  $("#chat").appendChild(div);
  $("#chat").scrollTop = $("#chat").scrollHeight;
  transcript.push({ speaker: role, text });

  // construir historial para /api/simulate
  if (role === "vendedor") history.push({ role:"user", content:text });
  else history.push({ role:"assistant", content:text });
}

function formatMMSS(totalSec){
  const s = Math.max(0, Math.floor(totalSec));
  const mm = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  return `${mm}:${ss}`;
}

/* ========= LOGIN (solo email) ========= */
function ensureEmail(){
  // guardamos en localStorage para no pedirlo cada vez
  userEmail = localStorage.getItem("ct_email") || "";
  if(!userEmail){
    userEmail = prompt("Introduce tu email corporativo para continuar:");
    if(!userEmail) userEmail = "anon@local";
    localStorage.setItem("ct_email", userEmail);
  }
  $("#who").textContent = userEmail;
}

/* ========= MODO (solo mostrar) ========= */
function setModePill(modeText){
  $("#modePill").textContent = `Modo: ${modeText}`;
}

/* ========= STOCK: cargar y elegir coche =========
   Formato de cada línea en /public/stock.txt
   Marca Modelo Año | Precio | Cuota | (opcional) URL (no la mostramos)
*/
async function loadRandomCar(){
  try{
    const r = await fetch('/stock.txt', { cache:'no-store' });
    if(!r.ok) throw new Error('stock.txt no disponible');
    const txt = await r.text();
    const lines = txt.split('\n').map(l=>l.trim()).filter(Boolean);
    const pick = lines[Math.floor(Math.random()*lines.length)];
    const [title="", price="", monthly=""] = pick.split('|').map(x=>(x||"").trim());

    chosenCar = { title, price, monthly };

    // primer mensaje del cliente (marca INICIO)
    const firstLines = [];
    if (title) firstLines.push(title);
    if (price || monthly) firstLines.push([price, monthly].filter(Boolean).join(' • '));
    const first =
`Hola, estaba mirando este coche:
${firstLines.join('\n')}
¿Podrías confirmarme si está disponible para verlo esta semana?`;

    bubble("cliente", first);

    // <<< AQUÍ COMIENZA LA MEDICIÓN DEL TIEMPO DEL ROLE-PLAY >>>
    startTime = Date.now();

  }catch(e){
    // fallback si falla stock
    chosenCar = { title: "SUV gasolina 2019", price:"", monthly:"" };
    bubble("cliente","Hola, estaba mirando un SUV gasolina de 2019 que vi en vuestra web. ¿Podría verlo esta semana?");
    startTime = Date.now();
    console.warn("Stock fallback:", e?.message || e);
  }
}

/* ========= SIMULAR CLIENTE (IA) ========= */
async function simulate(){
  const payload = {
    history,
    car: chosenCar,
    nivel: DEFAULT_MODE,
    email: userEmail
  };
  const r = await fetch('/api/simulate', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });
  const data = await r.json();
  bubble("cliente", data.reply || "¿Podrías aclararlo?");
}

/* ========= FINALIZAR & EVALUAR (con tiempo total) ========= */
async function finish(){
  if (locked) return;
  locked = true;
  $("#send").disabled = true;
  $("#finish").disabled = true;

  // duración total en segundos desde el primer mensaje del cliente
  const durationSec = startTime ? (Date.now() - startTime)/1000 : 0;

  // enviamos a tu backend de evaluación
  const r = await fetch('/api/evaluate', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({
      transcript,
      car: chosenCar,
      nivel: DEFAULT_MODE,
      email: userEmail,
      durationSec
    })
  });

  const text = await r.text();

  // mostramos tiempo + resultado
  const human = formatMMSS(durationSec);
  const pre = document.createElement('pre');
  pre.textContent = `Tiempo total del role‑play: ${human}\n\n${text}`;
  $("#result").appendChild(pre);
}

/* ========= EVENTOS UI ========= */
$("#send").onclick = async ()=>{
  const v = $("#input").value.trim();
  if(!v) return;
  $("#input").value = "";
  bubble("vendedor", v);
  await simulate();
};
$("#finish").onclick = finish;

/* ========= ARRANQUE ========= */
setModePill(DEFAULT_MODE);
ensureEmail();
loadRandomCar();
</script>
