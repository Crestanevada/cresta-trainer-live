<!doctype html>
<meta charset="utf-8" />
<title>CrestaTrainer • Demo</title>
<style>
  :root{
    --brand:#cc0000; --ok:#2ecc71; --bg:#f5f5f5; --card:#ffffff;
    --chat-bg:#fafafa; --border:#e0e0e0; --text:#212121;
  }
  html,body{height:100%}
  body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
       margin:0;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
  header{background:var(--brand);color:#fff;padding:10px 14px;font-weight:700;display:flex;gap:12px;align-items:center}
  .pill{background:#00000022;padding:4px 8px;border-radius:999px;font-size:12px}
  #wrap{max-width:980px;width:100%;margin:16px auto;background:var(--card);border-radius:12px;padding:16px;
        box-shadow:0 10px 20px rgba(0,0,0,.06);flex:1;display:flex;flex-direction:column}
  #top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  #timer{font-weight:800}
  #chat{border:1px solid var(--border);border-radius:10px;padding:12px;height:56vh;overflow:auto;background:var(--chat-bg)}
  .b{margin:8px 0;padding:10px 12px;border-radius:10px;max-width:74%;white-space:pre-wrap;line-height:1.35}
  .cli{background:#eee;color:#111}
  .ven{background:var(--brand);color:#fff;margin-left:auto}
  #bar{display:flex;gap:8px;margin-top:12px}
  #input{flex:1;padding:12px;border-radius:8px;border:1px solid #ddd}
  button{background:var(--ok);color:#fff;border:0;border-radius:8px;padding:10px 16px;font-weight:700;cursor:pointer}
  button.warn{background:#f4b400;color:#222}
  pre{background:#111;color:#0f0;padding:12px;border-radius:8px;overflow:auto}
  #meta{font-size:12px;opacity:.85}
</style>

<header>
  <span class="pill" id="modeBadge">Modo: FÁCIL</span>
  <span id="userEmail">–</span>
</header>

<div id="wrap">
  <div id="top">
    <div id="meta"></div>
    <div id="timer">10:00</div>
  </div>

  <div id="chat"></div>

  <div id="bar">
    <textarea id="input" rows="2" placeholder="Escribe tu respuesta..."></textarea>
    <button id="send">Enviar</button>
    <button id="finish" class="warn">Finalizar</button>
  </div>

  <div id="result"></div>
</div>

<script>
/* ==========================
   CONFIG
========================== */
const SESSION_MINUTES = 10;            // tiempo total
const START_MODE = "FÁCIL";            // mostrado (no se elige)
const CLIENT_NAME_POOL = ["Laura","Carlos","Marta","Diego","Ana","Javier","Elena","Sergio"];
const ALLORIGINS_LIST_URL = (p=1)=>`https://api.allorigins.win/raw?url=${encodeURIComponent('https://www.crestanevada.es/coches-segunda-mano/?_paged='+p)}`;
const SCRAPE_TIMEOUT_MS = 3500;        // corta al fallback si tarda demasiado

/* ==========================
   ESTADO
========================== */
let history = [];
let transcript = [];
let chosenCar = null;
let locked = false;

let startTs = Date.now();
let deadline = startTs + SESSION_MINUTES*60*1000;

let vendedorEmail = "";
let clientName = CLIENT_NAME_POOL[Math.floor(Math.random()*CLIENT_NAME_POOL.length)];

/* ==========================
   UTILS
========================== */
function fmtTimeLeft(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const mm = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  return `${mm}:${ss}`;
}
function escapeHtml(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");}
function linkifySafe(s){ return escapeHtml(s); } // sin links clicables por ahora
function bubble(role, text){
  const div = document.createElement('div');
  div.className = 'b ' + (role==="cliente" ? "cli" : "ven");
  if(role==="cliente"){ div.innerHTML = linkifySafe(text); history.push({role:"assistant", content:text}); }
  else{ div.textContent = text; history.push({role:"user", content:text}); }
  document.getElementById('chat').appendChild(div);
  const chat = document.getElementById('chat'); chat.scrollTop = chat.scrollHeight;
  transcript.push({speaker: role, text, ts: Date.now()});
}

/* ==========================
   TEMPORIZADOR VISIBLE
========================== */
function tick(){
  const left = deadline - Date.now();
  document.getElementById('timer').textContent = fmtTimeLeft(left);
  if(left<=0 && !locked){ finish(); }
}
setInterval(tick, 500);

/* ==========================
   STOCK: obtener coche aleatorio (robusto)
========================== */
function delay(ms){ return new Promise(res=>setTimeout(res, ms)); }

async function pickCarFromWebsite(){
  const page = 1 + Math.floor(Math.random()*3);
  const r = await fetch(ALLORIGINS_LIST_URL(page), { cache:'no-store' });
  if(!r.ok) throw new Error('Listado web no accesible');
  const html = await r.text();

  const linkRe = /href="(https:\/\/www\.crestanevada\.es\/coches-segunda-mano\/[^"]+)"[^>]*>([^<]+)<\/a>/gi;
  let m, items = [];
  while((m = linkRe.exec(html))!==null){
    const url = m[1];
    let title = m[2].replace(/\s+/g,' ').trim();
    if(title.length < 6) continue;
    const slice = html.slice(Math.max(0, m.index-400), m.index+400);
    const priceM = slice.match(/(\d{1,3}(?:\.\d{3})+|\d{4,6})\s*€/);
    const price = priceM ? priceM[0] : '';
    const monthlyM = slice.match(/(\d{1,3}(?:\.\d{3})*|\d{2,4}(?:,\d{2})?)\s*€\s*\/\s*mes/i);
    const monthly = monthlyM ? monthlyM[0] : '';
    items.push({ title, price, monthly, url });
  }
  if(items.length===0) throw new Error('No se detectaron coches');
  return items[Math.floor(Math.random()*items.length)];
}

async function pickCarFromLocal(){
  const r = await fetch('/stock.txt', { cache:'no-store' });
  if(!r.ok) throw new Error('No existe stock.txt');
  const txt = await r.text();
  const lines = txt.split('\n').map(l=>l.trim()).filter(Boolean);
  if(!lines.length) throw new Error('stock.txt vacío');
  const raw = lines[Math.floor(Math.random()*lines.length)];
  const [title="", price="", monthly="", url=""] = raw.split('|').map(x=>(x||"").trim());
  return { title, price, monthly, url };
}

async function loadRandomCarAndGreet(){
  // muestra un placeholder para que nunca veas vacío
  const placeholder = "Buscando un coche del stock…";
  bubble("cliente", placeholder);

  let car = null;

  // carrera: scraping con timeout
  try{
    car = await Promise.race([
      pickCarFromWebsite(),
      (async()=>{ await delay(SCRAPE_TIMEOUT_MS); throw new Error('timeout'); })()
    ]);
  }catch(_){
    // plan B: stock.txt
    try{ car = await pickCarFromLocal(); }
    catch(_2){ car = { title:"un SUV gasolina que vi en vuestra web", price:"", monthly:"", url:"" }; }
  }

  chosenCar = car;

  // sustituimos el placeholder por el mensaje real (añadimos una nueva burbuja y quitamos la anterior)
  const chat = document.getElementById('chat');
  chat.removeChild(chat.firstChild); // quita el placeholder

  const parts = [];
  if(car.title) parts.push(car.title);
  if(car.price || car.monthly){
    const p = [car.price, car.monthly].filter(Boolean).join(' · ');
    parts.push(p);
  }
  const head = parts.length ? `'${parts.join(', ')}',` : "";
  const firstMsg =
`Hola, estaba mirando este coche:
${head}
¿Podrías confirmarme si está disponible para verlo esta semana?`;

  bubble("cliente", firstMsg);
}

/* ==========================
   IA: turno del cliente
========================== */
async function simulateTurn(){
  const body = { history, car: chosenCar, nivel: START_MODE, vendedorEmail, clientName };
  const r = await fetch('/api/simulate',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  const data = await r.json();
  bubble("cliente", data.reply || "¿Podrías repetirme? No me ha quedado claro.");
}

/* ==========================
   Finalizar + Evaluar
========================== */
async function finish(){
  locked = true;
  document.getElementById('send').disabled = true;
  document.getElementById('finish').disabled = true;
  const durationMs = Date.now() - startTs;

  const r = await fetch('/api/evaluate',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ transcript, car: chosenCar, vendedorEmail, nivel: START_MODE, durationMs })
  });
  const data = await r.text();
  const pre = document.createElement('pre'); pre.textContent = data;
  document.getElementById('result').appendChild(pre);
}

/* ==========================
   INIT UI
========================== */
async function init(){
  vendedorEmail = localStorage.getItem('ct_email') || "";
  while(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(vendedorEmail)){
    vendedorEmail = prompt("Introduce tu email corporativo para empezar:") || "";
  }
  localStorage.setItem('ct_email', vendedorEmail);

  document.getElementById('modeBadge').textContent = `Modo: ${START_MODE}`;
  document.getElementById('userEmail').textContent = vendedorEmail;
  document.getElementById('meta').textContent = `Cliente: ${clientName}`;

  await loadRandomCarAndGreet();
}
document.getElementById('send').onclick = async ()=>{
  const v = document.getElementById('input').value.trim();
  if(!v || locked) return;
  document.getElementById('input').value = "";
  bubble("vendedor", v);
  await simulateTurn();
};
document.getElementById('finish').onclick = finish;
init();
</script>
